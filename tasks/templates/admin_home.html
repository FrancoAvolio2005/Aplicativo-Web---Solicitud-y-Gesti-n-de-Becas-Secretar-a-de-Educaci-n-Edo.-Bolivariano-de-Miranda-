<!-- Este código representa el Panel de Administración principal de la aplicación de gestión de becas.

Esta plantilla extiende la estructura base (admin_dashboard.html), e inyecta todo el contenido específico (bienvenida, módulos, modals, y lógica de permisos) dentro del bloque (block content). -->

{% extends 'admin_dashboard.html' %}
{% load static %}

{% block content %}

{% if messages %} <!-- Muestra mensajes flash generados por Django (por ejemplo, éxito al registrar un usuario, error de formulario) usando alertas de Bootstrap que se pueden cerrar (alert-dismissible). -->
    <div class="container mt-4">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="container py-4">
    {% if user.is_authenticated %}
    <h1 class="display-5 text-center mb-4">¡Bienvenido, usuario {{ user.username }}!</h1>
    {% endif %}

    <hr>

    <section class="text-center mb-5">
        <h2 class="display-6 fw-bold mb-4">Panel de Control</h2>
        <p class="fs-5 text-muted mb-4">
            Este espacio ha sido diseñado para ofrecerte una gestión eficiente y centralizada de todas las operaciones de tu
            plataforma. Desde aquí, tendrás el poder de supervisar, analizar y optimizar el rendimiento de tu aplicación web
            con herramientas intuitivas y accesibles.
        </p>
        <img src="{% static 'img/img-06.jpg' %}" alt="Imagen de bienvenida al panel administrativo" class="img-fluid">
        <p class="mt-4 text-secondary">"La gestión eficiente es la clave del éxito en cualquier plataforma digital"</p>
    </section>

    <hr>

    <h2 class="text-center mb-4 h3 fw-bold text-dark d-flex justify-content-center align-items-center">
        Módulos de la Aplicación
        <ion-icon name="cube-outline" class="text-secondary ms-2" style="font-size: 2.5rem;"></ion-icon>
    </h2>

    <br>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 justify-content-center">
        <div class="col">
            <div class="card h-100 shadow-sm border-0">
                <!-- Módulo de Solicitudes, tiene su "Modal" que te da las opciones de acceder a las "solicitudes pendientes", "solicitudes aprobadas" y "solicitudes rechazadas"  -->
                <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                    <h5 class="card-title text-center mb-3">
                        <ion-icon name="document-text-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;">
                        </ion-icon>
                        Solicitudes
                    </h5>
                    <p class="card-text text-center text-muted">Gestiona las solicitudes de becas y los trámites de los usuarios.
                    </p>
                    <div class="d-grid gap-2 mt-auto">
                        {% if user.is_superuser %} <!-- Lógica que se aplica para que los analistas internos del bienestar estudiantil (superuser) tengan acceso a las solicitudes de la aplicación, los analista (CDCE) no tienen acceso a este modulo -->
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modal">Gestionar Solicitudes</button>
                        {% else %} <!-- Restricción para que los analistas CDCE no accedan a este módulo -->
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#restrictedModal">Gestionar Solicitudes</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 shadow-sm border-0">
                <!-- Módulo de Estadísticas, los analistas CDCE si tienen acceso -->
                <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                    <h5 class="card-title text-center mb-3">
                        <ion-icon name="stats-chart-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;">
                        </ion-icon>
                        Estadísticas
                    </h5>
                    <p class="card-text text-center text-muted">Visualiza datos y gráficos sobre los datos registrados en el
                        aplicativo web.</p>
                        <div class="d-grid mt-auto">
                            <a href="{% url 'estadísticas' %}" class="btn btn-warning">Ver Estadísticas</a>
                        </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card h-100 shadow-sm border-0">
                <!-- Módulo de Reportes en EXCEL, tiene su Modal que te permite selecccionar y descargar que reporte desees obtener (se utiliza openpyxl para generar los reportes en excel) -->
                <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                    <h5 class="card-title text-center mb-3">
                        <ion-icon name="newspaper-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;"></ion-icon>
                        Reportes Excel
                    </h5>
                    <p class="card-text text-center text-muted">Genera y descarga reportes en formato Excel.</p>
                    <div class="d-grid mt-auto">
                        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modal3">Generar Reportes</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-100"></div>

        <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <!-- Módulo para asignar becas, los analistas CDEC no pueden realizar está acción -->
                <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                    <h5 class="card-title text-center mb-3">
                        <ion-icon name="folder-open-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;">
                        </ion-icon>
                        Asignar Becas
                    </h5>
                    <p class="card-text text-center text-muted">Asignar Becas para las solicitudes aprobadas.</p>
                    <div class="d-grid mt-auto">
                        {% if user.is_superuser %}
                            <a href="/asig_beca" class="btn btn-warning">Asignar Becas</a>
                        {% else %}
                            <a href="#" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#restrictedModal">Asignar Becas</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
                <!-- Módulo o apartado del panel de administración para ver la actividad de los solicitantes en cuestión de sus solicitudes y otrod datos -->
                <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                    <h5 class="card-title text-center mb-3">
                        <ion-icon name="analytics-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;">
                        </ion-icon>
                        Revisar Actividad
                    </h5>
                    <p class="card-text text-center text-muted">Conuslta la actividad de los usuarios solicitantes.
                    </p>
                    <div class="d-grid mt-auto">
                        <a href="/ver_actividad" class="btn btn-warning">Ver Actividad</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- Sección de recursos y ayuda que contiene el manual de usuario (administración de la aplicación) -->

<h2 class="text-center mb-4 h3 fw-bold text-dark d-flex justify-content-center align-items-center">
    Recursos y Ayuda
    <ion-icon name="construct-outline" class="text-secondary ms-2" style="font-size: 2.5rem;"></ion-icon>
</h2>

<br>

<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body d-flex flex-column justify-content-between shadow-lg">
                <h5 class="card-title text-center mb-3">
                    <ion-icon name="library-outline" class="me-2" style="font-size: 2rem; vertical-align: middle;"></ion-icon>
                    Manual de Usuario
                </h5>
                <p class="card-text text-center text-muted">Si tienes dudas de como usar la aplicación, consulta aquí el manual
                    de usuario.</p>
                <div class="d-grid gap-2 mt-auto">
                    <a href="{% static 'manuales/Becas Manual de Administrador.pdf' %}" class="btn btn-warning">Manual de usuario</a>
                </div>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- Sección de la aplicación para Gestionar (CRUD) entidades de la base de datos, cambiar contraseña y otras cosas más... -->

<section class="container py-4 mb-5">
    <h2 class="text-center mb-4 h3 fw-bold text-dark d-flex justify-content-center align-items-center">
        Enlaces Rápidos y Acciones Comunes
        <ion-icon name="flash-outline" class="text-secondary ms-2" style="font-size: 2.5rem;"></ion-icon>
    </h2>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 text-center">
        <div class="col">
            {% if user.is_superuser %} <!-- Si es analista interno tiene acceso, si es analista CDCE no tiene -->
                <a href="/admin/tasks/becas/" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4">
                    <ion-icon name="school-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Gestión de Becas</p>
                </a>
            {% else %}
                <a href="#" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4" data-bs-toggle="modal" data-bs-target="#restrictedModal">
                    <ion-icon name="school-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Gestión de Becas</p>
                </a>
            {% endif %}
        </div>
        <div class="col">
            {% if user.is_superuser %}
                <a href="/admin/auth/user/" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4">
                    <ion-icon name="people-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Gestión de Usuarios</p>
                </a>
            {% else %}
                <a href="#" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4" data-bs-toggle="modal" data-bs-target="#restrictedModal">
                    <ion-icon name="people-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Gestión de Usuarios</p>
                </a>
            {% endif %}
        </div>
        <div class="col">
            {% if user.is_superuser %}
                <a href="/admin/password_change/" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4">
                    <ion-icon name="key-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Cambiar Contraseña</p>
                </a>
            {% else %}
                <a href="#" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4" data-bs-toggle="modal" data-bs-target="#restrictedModal">
                    <ion-icon name="key-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Cambiar Contraseña</p>
                </a>
            {% endif %}
        </div>
        <div class="col">
            <a href="#"
                class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4"
                data-bs-toggle="modal" data-bs-target="#contactModal">
                <ion-icon name="mail-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                <p class="fw-bold mt-2 mb-0">Contactar al Equipo de Desarrollo</p>
            </a>
        </div>
    </div>
    <div class="row justify-content-center mt-4">
        <div class="col-12 col-md-6 col-lg-4">
            {% if user.is_superuser %}
            <a href="/admin/"
            class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4">
                <ion-icon name="settings-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                <p class="fw-bold mt-2 mb-0">Configuración General de la Aplicación</p>
            </a>
            {% else %}
            <a href="#"
            class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4"
            data-bs-toggle="modal" data-bs-target="#restrictedModal">
                <ion-icon name="settings-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                <p class="fw-bold mt-2 mb-0">Configuración General de la Aplicación</p>
            </a>
            {% endif %}
        </div>

        <!-- Carta para registrar analista externos por petición de otras Entidades de Educación, está acción solo se puede hacer por un analista interno, contiene un modal que sirve como ventana emergente -->

        <div class="col-12 col-md-6 col-lg-4">
            <a href="#"
                class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4"
                data-bs-toggle="modal" data-bs-target="#analystModal">
                <ion-icon name="person-add-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                <p class="fw-bold mt-2 mb-0">Registrar Analistas Externos CDCE</p>
            </a>
        </div>

        <!-- Formulario con Modal para registrar Analistas internos, solo se puede hacer por otro analista interno ya registrado -->

        <div class="col-12 col-md-6 col-lg-4">
            {% if user.is_superuser %}
            <a href="#"
                class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4"
                data-bs-toggle="modal" data-bs-target="#analystBienestarModal">
                <ion-icon name="person-add-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                <p class="fw-bold mt-2 mb-0">Registrar Analistas Internos Bienestar Estudiantil</p>
            </a>
            {% else %}
                <a href="#" class="card card-body shadow-sm h-100 d-flex flex-column justify-content-center align-items-center btn btn-light py-4" data-bs-toggle="modal" data-bs-target="#restrictedModal">
                    <ion-icon name="person-add-outline" style="font-size: 3rem; color: #6c757d;"></ion-icon>
                    <p class="fw-bold mt-2 mb-0">Registrar Analistas Internos Bienestar Estudiantil</p>
                </a>
            {% endif %}
        </div>
    </div>
</section>

<div class="modal fade" id="modal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Gestionar Solicitudes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="/solic_pendiente" class="btn btn-warning w-100">Solicitudes Pendientes</a></li>
                    <li class="mb-2"><a href="/solic_rechazadas" class="btn btn-warning w-100">Solicitudes Rechazadas</a></li>
                    <li class="mb-2"><a href="/solic_aprobadas" class="btn btn-warning w-100">Solicitudes Aprobadas</a></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal3" tabindex="-1" aria-labelledby="modalLabel3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel3">Generar Reportes Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="{% url 'export_profiles_excel' %}" class="btn btn-warning w-100">Descargar listado de Solicitantes</a></li>
                    <li class="mb-2"><a href="{% url 'export_solicitudes_excel' %}" class="btn btn-warning w-100">Descargar listado de Solicitudes</a></li>
                    <li class="mb-2"><a href="{% url 'export_becas_excel' %}" class="btn btn-warning w-100">Descargar listado de Becas</a></li>
                    <li class="mb-2"><a href="{% url 'export_planteles_excel' %}" class="btn btn-warning w-100">Descargar listado de Planteles</a></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactModalLabel">Contactar al Equipo de Desarrollo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Puedes contactar al equipo de desarrollo a través de los siguientes correos electrónicos:</p>
                <ul class="list-unstyled">
                    <li><a href="mailto:luisavolio2005@gmail.com">dev.franco2005@gmail.com</a></li>
                    <li><a href="mailto:cedenodeiver@gmail.com">cedenodeiver@gmail.com</a></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="analystBienestarModal" tabindex="-1" aria-labelledby="analystBienestarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="analystBienestarModalLabel">Registrar Analistas Internos Bienestar Estudiantil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    {{ superuser_form.as_p }} 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" name="superuser_register" class="btn btn-warning">Registrar Superusuario</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="analystModal" tabindex="-1" aria-labelledby="analystModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="analystModalLabel">Registrar Analistas Exteriores CDCE</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="{{ analista_form.username.id_for_label }}" class="form-label">Nombre de usuario</label>
                        {{ analista_form.username }}
                        {% if analista_form.username.errors %}
                            <div class="text-danger">
                                {% for error in analista_form.username.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ analista_form.password.id_for_label }}" class="form-label">Contraseña</label>
                        <div class="input-group">
                        {{ analista_form.password1 }}
                        <button type="button" class="input-group-text" id="togglePassword1">
                            <ion-icon name="eye-outline"></ion-icon>
                        </button>
                        </div>
                        {% if analista_form.password1.errors %}
                            <div class="text-danger">
                                {% for error in analista_form.password.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="{{ analista_form.password2.id_for_label }}" class="form-label">Confirmación de contraseña</label>
                        <div class="input-group">
                        {{ analista_form.password2 }}
                        <button type="button" class="input-group-text" id="togglePassword2">
                            <ion-icon name="eye-outline"></ion-icon>
                        </button>
                    </div>
                        {% if analista_form.password2.errors %}
                            <div class="text-danger">
                                {% for error in analista_form.password2.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" name="analista_register" class="btn btn-warning">Registrar Analista</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="restrictedModal" tabindex="-1" aria-labelledby="restrictedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="restrictedModalLabel">Acceso Restringido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-center fw-bold">Los Analistas Exteriores del Municipio no tienen acceso a este módulo.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        function setupPasswordToggle(inputId, toggleButtonId) {
            const passwordInput = document.querySelector(`#${inputId}`);
            const toggleButton = document.querySelector(`#${toggleButtonId}`);

            if (passwordInput && toggleButton) {
                toggleButton.addEventListener('click', function () {
                    
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);

                    const icon = this.querySelector('ion-icon');
                    const iconName = icon.getAttribute('name') === 'eye-outline' ? 'eye-off-outline' : 'eye-outline';
                    icon.setAttribute('name', iconName);
                });
            }
        }

        setupPasswordToggle('id_password1', 'togglePassword1');

        setupPasswordToggle('id_password2', 'togglePassword2');
    });
</script>


{% endblock %}